<div id="graphQuestions">
<div id="graphQTimer"></div>
<p id="graphQInstructions">
<strong>Please play close attention to the story. You will be asked to answer questions about the story's content.</strong>
</p>
<div id="graphQImage"></div>
<div id="graphQText"></div>
<div id="graphQVerification"></div>
</div>

<style>
</style>

<script>
(function() {
  var data = {}
    , rand = Math.floor(Math.random()*3) // 0, 1, 2
    , storyData;

  init();

  function init() {
    data.mod1=[]
    experimentr.hideNext();
    experimentr.startTimer('graphQuestions');

    experimentr.attachTimer('#graphQTimer', 20, function() {
      d3.select('#graphQTimer').remove();
      loadQuestion();
    });

    d3.json('modules/graphQuestions/graphList.json', function(err, d) {
      storyData = d[0]
      // data.primingType = rand === 0 ? 'negative' : rand === 1 ? 'positive' : 'neutral';
      // storyData = data.primingType === 'negative' ? d[0] : data.primingType === 'positive' ? d[1] : d[2]; // 0 negative; 1 positive; 2 neutral
      loadStory();
    });
  }
  function loadStory() {
    // Appending the graph Image...hardcoded for now...
    d3.select('#graphQImage').append('img')
      .attr('class', 'picture')
      .attr('src', function(d) { return "modules/graphQuestions/graphImages/line_climateChange.png"; });
    // Used to add the text of story
    // d3.select('#graphQText').append('div')
    //   .html(storyData.story);
    // Adds the option for the participant to skip past waiting....might include for testing purposes and remove later. s
    d3.select('#graphQText').append('button')
      .attr('type', 'button')
      .text('I have finished reading the story and I am ready for the questions.')
      .on('click',
        function(d) {
          loadQuestion();
          experimentr.attachTimerEnd('#graphQTimer')
        });
  }
  function loadQuestion() {
    experimentr.showNext();
    d3.select('#graphQText').remove();
    d3.select('#graphQInstructions').remove();
    // only looking at one thing for now
    for (var i=0; i<1; i++){
      data.mod1.push({key: storyData.type, inputData: []})
    }
    for (let i=0; i<storyData.questionBank.length; i++){
      data.mod1[0].inputData.push({questionType: storyData.questionBank[i].key})
      var question = d3.select('#graphQVerification').append("g")
      question.append('p')
        .text(storyData.questionBank[i].question);
      var choices = question.selectAll('.choice')
        .data(storyData.questionBank[i].choices)
        .enter().append('div')
        .classed('choice', true);
      choices.append('input')
        .attr('type', 'radio')
        .attr('name', 'graphQVerification'+i.toString())
        .attr('value', function(d) { return d; });
      choices.append('label')
        .text(function(d) { return d; });
      d3.selectAll('input')
        .filter(function(d) {
          console.log("i", i)
          return this.name === 'graphQVerification'+i.toString() ? this : null; })
        .on('change', function() {
          console.log("i2", i)
          console.log(this.name, this.value, data.mod1[0].inputData[i], i)
          data.mod1[0].inputData[i].userAnswer = this.value
          diffGradeMeth();
          data.graphQVerification = this.value; validate();
        });
    }
  }
  // allow the participant to move on to the next
  function validate() {
    console.log("validate")
    if(data.graphQVerification) {
      grade();
      experimentr.endTimer('graphQuestions');
      experimentr.addData(data);
      experimentr.release();
    }
  }
  function diffGradeMeth(){
    for (var i=0; i<data.mod1[0].inputData.length; i++){
      if (data.mod1[0].inputData[i].userAnswer==storyData.questionBank[i].answer){
        data.mod1[0].inputData[i].answerVerification = true
      } else { data.mod1[0].inputData[i].answerVerification = false}
      data.modStuff=JSON.stringify(data.mod1)
      console.log(JSON.parse(data.modStuff))
      // console.log("apples", JSON.parse("apples"))
    }
  }
  function grade() {
    if(data.graphQVerification === storyData.answer)
      data.graphQVerificationResult = true;
    else
      data.graphQVerificationResult = false;
  }
}());
</script>
